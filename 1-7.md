Nice — this report is exactly what we needed. Now we can proceed **without guessing**.

I’m going to turn this into a **concrete “Proceed Plan”** with (a) decisions you must lock, (b) the extraction map, (c) the exact module contracts to create, and (d) acceptance checks. No fluff.

---

## 1) Lock 3 Decisions (do these now, or you’ll redo work)

### Decision A — Migrations vs schema.sql

**Pick this:** ✅ **Keep `schema.sql` as the source of truth for now**, and create a **migration folder later** when you introduce CI or multiple environments.

Why: you currently have *one SQL file already applied* and no `supabase/migrations/`. Creating a migration chain now is extra moving parts without benefit.

**Rule:**

* `schema.sql` = canonical schema
* `database.types.ts` = generated from Supabase (keep it generated)

Later, when you add local Supabase CLI, we’ll migrate to migrations.

---

### Decision B — Course belongs to multiple paths

You already have `path_courses` junction table. That means **one course can be in multiple paths** (unless you enforce uniqueness).

For Studio back link, choose:

✅ **Rule:** Use **the first linked path by `order_index ASC, created_at ASC`**.
(Deterministic, simplest, works now.)

Later you can add `primary_path_id` if needed.

---

### Decision C — Auth calls in UI vs data layer

✅ Keep **auth forms** in UI (`login/signup`) for now.
Everything else goes into `lib/db/*` (server-side) and pages call those functions.

---

## 2) Extraction Target (What “Done” looks like)

### After extraction:

* `app/(workspace)/**` pages **do not call `.from()`**
* `components/**` **do not import Supabase**
* Only `lib/supabase/server.ts` and `lib/db/**` touch Supabase server client
* Only login/signup pages use browser client

---

## 3) The Actual Extraction Map (from your discovery)

### Must extract from UI → into `lib/db/*`

**Pages**

* `app/(workspace)/paths/page.tsx`
* `app/(workspace)/paths/new/page.tsx`
* `app/(workspace)/paths/[pathId]/page.tsx`
* `app/(workspace)/paths/[pathId]/courses/new/page.tsx`
* `app/(workspace)/studio/[lessonId]/page.tsx`

**Components**

* `components/YouTubePlayer.tsx` (progress upsert)
* `components/NotesPanel.tsx` (notes CRUD)

**Utilities**

* `lib/utils/progress.ts` (DB-coupled)
* `lib/db/queries.ts` (DB-coupled)

✅ Safe to remain shared:

* `lib/utils/youtube.ts` (PURE)

---

## 4) Create These Modules (VS Code authority layer)

Create folder: `lib/db/`

### `lib/db/paths.ts`

* `getPathsForUser()`
* `createPath(input)`
* `getPathById(pathId)`
* `updatePath(pathId, input)`

### `lib/db/courses.ts`

* `getCoursesForPath(pathId)`
* `createCourseAndLinkToPath(pathId, input)`
* `getCourseById(courseId)`
* `updateCourse(courseId, input)`

### `lib/db/lessons.ts`

* `getLessonsForCourse(courseId)`
* `getLessonById(lessonId)`

### `lib/db/notes.ts`

* `getNotesForLesson(lessonId)`
* `upsertNoteForLesson(lessonId, content)`

### `lib/db/progress.ts`

* `getProgressForLesson(lessonId)`
* `setLessonStatus(lessonId, status)`
* `upsertPlaybackPosition(lessonId, position)`

### `lib/db/context.ts`

* ✅ **`getLessonContext(lessonId)`**

  * returns `{ pathId, courseId, lessonId, pathTitle?, courseTitle? }`
  * uses: lessons → course_id → path_courses → path_id

This fixes the Studio `"temp"` bug.

---

## 5) Fix the “duplicate server client” issue (important)

Your report says:

* `middleware.ts` and `auth/callback/route.ts` use **inline** `createServerClient`

✅ Standardize them to import your canonical `createSupabaseServerClient()` from `lib/supabase/server.ts`.

This prevents cookie handling drift.

---

## 6) Acceptance Tests (must pass before moving on)

### Grep checks

Run from repo root:

* No Supabase in workspace pages/components:

  * `rg "@supabase" studystudio/app/(workspace) studystudio/components`
  * `rg "\\.from\\(" studystudio/app/(workspace) studystudio/components`

Expected: **0 hits**

### Manual flow

1. `/signup` create user
2. Redirect → `/paths`
3. Create path → redirect `/paths/[pathId]`
4. Add course → redirect `/paths/[pathId]/courses/[courseId]`
5. Open lesson → `/studio/[lessonId]`
6. Studio “Back to Course” link must be:

   * `/paths/{realPathId}/courses/{courseId}` (no temp)

### Refresh test

* Refresh `/paths` and `/studio/[lessonId]` keeps session.

---

## 7) What I need from you to proceed (minimal)

To give you the **exact code skeletons** (not just structure), paste these file contents:

1. `lib/supabase/server.ts`
2. `app/(workspace)/studio/[lessonId]/page.tsx`
3. `components/NotesPanel.tsx`
4. `components/YouTubePlayer.tsx`

With those, I can output:

* `lib/db/context.ts` + `getLessonContext`
* `lib/db/notes.ts` and `lib/db/progress.ts`
* Minimal diffs to remove Supabase from UI

No extra questions needed.

If you don’t want to paste code, you can still proceed using the checklist above—just slower.
